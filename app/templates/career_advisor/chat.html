{% extends "base.html" %}
{% block content %}
<div class="row chat-container">
    <!-- Sidebar -->
        <div class="col-md-4 col-lg-3 mb-3" id="chat-sidebar">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Your Conversations</h5>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('career_advisor.chat_with_ai') }}">New</a>
        </div>
        <div class="list-group" style="max-height: 70vh; overflow-y: auto;">
            {% if chat_sessions %}
                {% for s in chat_sessions %}
                                <div class="list-group-item p-2 {% if session_id == s.id %}active{% endif %}">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <div class="d-flex align-items-center" style="gap:.5rem; flex:1; min-width:0;">
                                            <a class="session-link text-reset" href="{{ url_for('career_advisor.chat_with_ai', session_id=s.id) }}">
                                                <strong class="mb-0 session-name text-truncate d-block" style="max-width: 14rem;">{{ s.session_name or ('Chat #' ~ s.id) }}</strong>
                                            </a>
                                            <input type="text" class="form-control form-control-sm session-name-input d-none" value="{{ s.session_name or ('Chat #' ~ s.id) }}" data-id="{{ s.id }}" style="max-width:14rem;">
                                        </div>
                                        <div class="btn-group btn-group-sm" role="group" aria-label="Session actions">
                                            <button type="button" class="btn btn-outline-secondary rename-session" data-id="{{ s.id }}" title="Rename">‚úèÔ∏è</button>
                                            <button type="button" class="btn btn-outline-danger delete-session" data-id="{{ s.id }}" title="Delete">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <div class="d-flex w-100 justify-content-between">
                                        {% set preview = (s.messages[-1].content if s.messages else '') %}
                                        <div class="text-truncate mr-2" style="max-width: 70%">{{ preview }}</div>
                                        <small>{{ s.created_date.strftime('%b %d %H:%M') }}</small>
                                    </div>
                                </div>
                {% endfor %}
            {% else %}
                <div class="list-group-item">No chats yet ‚Äî start a new one!</div>
            {% endif %}
        </div>
    </div>

    <!-- Conversation -->
            <div class="col-md-8 col-lg-9" id="chat-main-col">
            <div class="card chat-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center" style="gap:.5rem;">
                        <button class="btn btn-sm btn-outline-secondary" id="toggle-sidebar" title="Toggle conversations">‚ò∞</button>
                        <span>AI Career Advisor</span>
                        <button type="button" class="btn btn-sm btn-outline-secondary ml-2" id="toggle-tts" title="Toggle read-aloud">üîä</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="start-voice" title="Speak your message">üé§</button>
                    </div>
                        {% if session_id %}
                        <div class="d-flex align-items-center" style="gap:.5rem;">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="auto-name">Auto-name</button>
                        </div>
                        {% endif %}
            </div>
                    <div class="card-body p-0">
                <div id="chat-messages" class="p-3">
                    {% if session_id %}
                        {% for message in messages %}
                            {% if message.sender == 'user' %}
                                                <div class="d-flex justify-content-end mb-2">
                                                    <div class="badge badge-light text-left p-2 chat-bubble chat-bubble-user" style="max-width: 70%;">{{ message.content }}</div>
                                </div>
                            {% else %}
                                                <div class="d-flex justify-content-start mb-2">
                                                    <div class="badge badge-light text-left p-2 chat-bubble chat-bubble-ai" style="max-width: 70%;">{{ message.content }}</div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted p-5">Start a new conversation from the left.</div>
                    {% endif %}
                </div>
                <div id="typing-indicator" class="px-3 pb-2" style="display:none;">
                    <small class="text-muted">AI is typing‚Ä¶</small>
                </div>
            </div>
            <div class="card-footer">
                <form id="chat-form" class="mb-0">
                    <div class="input-group">
                        <textarea class="form-control" id="user-input" rows="1" placeholder="Type your message... (Shift+Enter for newline)" style="overflow:hidden; resize:none; transition: height .15s ease; max-height: 200px;"></textarea>
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="submit">Send</button>
                        </div>
                    </div>
                    <input type="hidden" id="session-id" value="{{ session_id or '' }}">
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
            const chatMessages = $('#chat-messages');
            const chatForm = $('#chat-form');
            const userInput = $('#user-input');
            const sessionId = $('#session-id').val();
             // no manual plan button; server will generate after consent
            const typing = $('#typing-indicator');

            // Draft persistence per session
            const draftKey = (sid) => `chat_draft_${sid || 'new'}`;
            function loadDraft() {
                try {
                    const d = localStorage.getItem(draftKey(sessionId));
                    if (d) userInput.val(d);
                } catch (e) {}
            }
            function saveDraft() {
                try {
                    const sid = $('#session-id').val();
                    localStorage.setItem(draftKey(sid), userInput.val());
                } catch (e) {}
            }
            loadDraft();
            userInput.on('input', saveDraft);

            function formatConcise(text) {
                // Enforce ~5 lines client-side unless looks like a domain explanation
                // Heuristic: if more than 7 lines and not containing keywords suggesting explanation, collapse
                const lines = text.split(/\r?\n/);
                if (lines.length <= 7) return { html: text, collapsed: false };
                const markerWords = /(algorithm|architecture|complexity|derivation|proof|regression|classification|database|indexing|compiler|network|protocol|encryption|mathematics|theorem|neural|transformer|domain|physics|chemistry|biology|economics|law|medicine)/i;
                const needsDetail = markerWords.test(text);
                if (needsDetail) return { html: text, collapsed: false };
                const head = lines.slice(0, 5).join("\n");
                const rest = lines.slice(5).join("\n");
                const id = 'ai_more_' + Math.random().toString(36).slice(2);
                const html = `${head}\n<span class="text-muted">‚Ä¶</span>\n<a href="#" class="show-more" data-target="${id}">Show full</a>\n<div id="${id}" class="d-none">\n<pre class="mb-0" style="white-space:pre-wrap">${$('<div/>').text(rest).html()}</pre>\n</div>`;
                return { html, collapsed: true };
            }

            function appendMessage(sender, message) {
                let row;
                if (sender === 'user') {
                    row = $(
                        '<div class="d-flex justify-content-end mb-2">' +
                        '  <div class="badge badge-light text-left p-2 chat-bubble chat-bubble-user" style="max-width:70%;"></div>' +
                        '</div>'
                    );
                } else {
                    row = $(
                        '<div class="d-flex justify-content-start mb-2">' +
                        '  <div class="badge badge-light text-left p-2 chat-bubble chat-bubble-ai" style="max-width:70%;"></div>' +
                        '</div>'
                    );
                }
                if (sender === 'ai') {
                    const conc = formatConcise(message);
                    row.find('.badge').html(conc.html);
                } else {
                    row.find('.badge').html(message);
                }
                chatMessages.append(row);
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }

            function loadChatMessages(sessionId) {
                $.ajax({
                    url: '/career/api/load_messages/' + sessionId,
                    type: 'GET',
                    success: function(data) {
                        chatMessages.empty(); // Clear existing messages
                        $.each(data.messages, function(index, message) {
                            appendMessage(message.sender, message.content);
                        });
                        chatMessages.scrollTop(chatMessages[0].scrollHeight);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading chat messages:', error);
                        console.log('Response Text:', xhr.responseText);
                        console.log('Status Code:', xhr.status);
                    }
                });
            }

            if (sessionId) {
                loadChatMessages(sessionId);
            }

            // Sidebar toggle with persistence
            const sidebar = $('#chat-sidebar');
            const mainCol = $('#chat-main-col');
            function applySidebarState(collapsed) {
                if (collapsed) {
                    sidebar.addClass('d-none');
                    mainCol.addClass('full-width');
                } else {
                    sidebar.removeClass('d-none');
                    mainCol.removeClass('full-width');
                }
            }
            const savedCollapsed = localStorage.getItem('chat_sidebar_collapsed') === '1';
            applySidebarState(savedCollapsed);
            $('#toggle-sidebar').on('click', function(){
                const isCollapsed = sidebar.hasClass('d-none');
                applySidebarState(!isCollapsed);
                localStorage.setItem('chat_sidebar_collapsed', !isCollapsed ? '1' : '0');
            });

            // Shift+Enter for newline; Enter submits
            userInput.on('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.trigger('submit');
                }
            });

            chatForm.on('submit', function(e) {
                e.preventDefault();
                const message = userInput.val();
                if (message.trim() === '') return;

                appendMessage('user', message);
                userInput.val('');
                saveDraft();
                typing.show();

                $.ajax({
                    url: "{{ url_for('career_advisor.api_chat') }}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ message: message, session_id: sessionId }),
                    success: function(data) {
                        typing.hide();
                        appendMessage('ai', data.response);
                        // Speak the AI response if enabled
                        speakTextIfEnabled(data.response);
                        if (data.plan_generated) {
                            window.location.href = "{{ url_for('career_advisor.career_tracker') }}";
                            return;
                        }
                        // Update session ID if new session is created
                        if (!sessionId && data.session_id) {
                            $('#session-id').val(data.session_id);
                            saveDraft();
                             loadChatMessages(data.session_id);
                             window.location.href = "{{ url_for('career_advisor.chat_with_ai') }}" + '?session_id=' + data.session_id;
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                         console.log('Response Text:', xhr.responseText);
            console.log('Status Code:', xhr.status);
                        appendMessage('ai', 'Sorry, I am having trouble connecting right now.');
                        typing.hide();
                    }
                });
            });

            // --- Voice: Text-to-Speech (TTS) toggle ---
            let ttsEnabled = false;
            function speakTextIfEnabled(text){
                if (!ttsEnabled) return;
                if (!('speechSynthesis' in window)) return;
                try {
                    const lines = (text || '').split(/\r?\n/).slice(0,5).join('\n');
                    const utter = new SpeechSynthesisUtterance(lines);
                    utter.rate = 1.05; // a bit brisk
                    // Use browser default language; could be improved with user preference
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utter);
                } catch(e) { /* noop */ }
            }
            $('#toggle-tts').on('click', function(){
                ttsEnabled = !ttsEnabled;
                $(this).toggleClass('active', ttsEnabled);
            });

            // --- Voice: SpeechRecognition (mic) ---
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognizer = null;
            if (SR) {
                recognizer = new SR();
                recognizer.lang = 'en-US';
                recognizer.interimResults = true;
                recognizer.maxAlternatives = 1;
                recognizer.onresult = function(event){
                    let transcript = '';
                    for (let i=event.resultIndex; i<event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    userInput.val(transcript);
                    autosize(userInput[0]);
                    if (event.results[event.results.length-1].isFinal) {
                        chatForm.trigger('submit');
                    }
                };
                recognizer.onerror = function(){ $('#start-voice').removeClass('active'); };
                recognizer.onend = function(){ $('#start-voice').removeClass('active'); };
            }
            $('#start-voice').on('click', function(){
                if (!recognizer) { alert('Voice input is not supported in this browser.'); return; }
                try {
                    window.speechSynthesis && window.speechSynthesis.cancel();
                    recognizer.start();
                    $(this).addClass('active');
                } catch(e) {
                    try { recognizer.stop(); } catch(_) {}
                    $(this).removeClass('active');
                }
            });

            // Delegate show-more toggles
            $(document).on('click', 'a.show-more', function(e){
                e.preventDefault();
                const id = $(this).data('target');
                $('#' + id).removeClass('d-none');
                $(this).remove();
            });
            // No manual plan generation; handled server-side on consent

            $('#auto-name').on('click', function(e){
                e.preventDefault();
                if (!sessionId) return;
                $.ajax({
                    url: `/career/api/chat_session/${sessionId}/autoname`,
                    type: 'POST',
                    success: function(d){ if (d.success) { $('.card-header span').text(d.name); } else { alert(d.error || 'Failed to auto-name'); } },
                    error: function(xhr){ alert('Auto-name failed: ' + (xhr.responseJSON && xhr.responseJSON.error || xhr.status)); }
                });
            });

            // Autosize textarea
            function autosize(el){
                const maxH = 200; // px
                el.style.height = 'auto';
                const newH = Math.min(el.scrollHeight, maxH);
                el.style.height = newH + 'px';
                el.style.overflowY = (el.scrollHeight > maxH) ? 'auto' : 'hidden';
            }
            autosize(userInput[0]);
            userInput.on('input', function(){ autosize(this); });

            // Sidebar actions: inline rename & delete
            $('.rename-session').on('click', function(e) {
                e.preventDefault();
                const container = $(this).closest('.list-group-item');
                const nameEl = container.find('.session-name');
                const inputEl = container.find('.session-name-input');
                container.find('.session-link').addClass('d-none');
                nameEl.addClass('d-none');
                inputEl.removeClass('d-none').focus().select();
            });

            $('.session-name-input').on('keydown', function(e){
                if (e.key === 'Enter') { $(this).trigger('blur'); }
                if (e.key === 'Escape') {
                    const container = $(this).closest('.list-group-item');
                    container.find('.session-link, .session-name').removeClass('d-none');
                    $(this).addClass('d-none');
                }
            });

            $('.session-name-input').on('blur', function(){
                const inputEl = $(this);
                const id = inputEl.data('id');
                const value = inputEl.val().trim();
                const container = inputEl.closest('.list-group-item');
                const nameEl = container.find('.session-name');
                if (!value || value === nameEl.text().trim()) {
                    container.find('.session-link, .session-name').removeClass('d-none');
                    inputEl.addClass('d-none');
                    return;
                }
                $.ajax({
                    url: `/career/api/chat_session/${id}/rename`,
                    type: 'POST', contentType: 'application/json', data: JSON.stringify({ name: value }),
                    success: function(){ nameEl.text(value); container.find('.session-link, .session-name').removeClass('d-none'); inputEl.addClass('d-none'); },
                    error: function(xhr){ alert('Rename failed: ' + (xhr.responseJSON && xhr.responseJSON.error || xhr.status)); container.find('.session-link, .session-name').removeClass('d-none'); inputEl.addClass('d-none'); }
                });
            });

            $('.delete-session').on('click', function(e) {
                e.preventDefault();
                const id = $(this).data('id');
                if (!confirm('Delete this session? This cannot be undone.')) return;
                $.ajax({
                    url: `/career/api/chat_session/${id}/delete`,
                    type: 'POST',
                    success: function() { window.location.href = `{{ url_for('career_advisor.chat_with_ai') }}`; },
                    error: function(xhr) { alert('Delete failed: ' + (xhr.responseJSON && xhr.responseJSON.error || xhr.status)); }
                });
            });
    });
</script>
{% endblock %}
